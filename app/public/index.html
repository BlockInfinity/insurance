<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">

	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!-- Custom styles for this template -->
    <style type="text/css">
		/* Space out content a bit */
		body {
		  padding-top: 1.5rem;
		  padding-bottom: 1.5rem;
		}

		/* Everything but the jumbotron gets side spacing for mobile first views */
		.header,
		.marketing,
		.footer {
		  padding-right: 1rem;
		  padding-left: 1rem;
		}

		/* Custom page header */
		.header {
		  padding-bottom: 1rem;
		  border-bottom: .05rem solid #e5e5e5;
		}
		/* Make the masthead heading the same height as the navigation */
		.header h3 {
		  margin-top: 0;
		  margin-bottom: 0;
		  line-height: 3rem;
		}

		/* Custom page footer */
		.footer {
		  padding-top: 1.5rem;
		  color: #777;
		  border-top: .05rem solid #e5e5e5;
		}

		/* Customize container */
		@media (min-width: 48em) {
		  .container {
		    max-width: 46rem;
		  }
		}
		.container-narrow > hr {
		  margin: 2rem 0;
		}

		/* Main marketing message and sign up button */
		.jumbotron {
		  text-align: center;
		  border-bottom: .05rem solid #e5e5e5;
		}
		.jumbotron .btn {
		  padding: .75rem 1.5rem;
		  font-size: 1.5rem;
		}

		/* Supporting marketing content */
		.marketing {
		  margin: 3rem 0;
		}
		.marketing p + h4 {
		  margin-top: 1.5rem;
		}

		/* Responsive: Portrait tablets and up */
		@media screen and (min-width: 48em) {
		  /* Remove the padding we set earlier */
		  .header,
		  .marketing,
		  .footer {
		    padding-right: 0;
		    padding-left: 0;
		  }
		  /* Space out the masthead */
		  .header {
		    margin-bottom: 2rem;
		  }
		  /* Remove the bottom border on the jumbotron for visual effect */
		  .jumbotron {
		    border-bottom: 0;
		  }
		}

		#loading {
		    border: 10px solid #f3f3f3 ; /* Light grey */
		    border-top: 10px solid #3498db ; /* Blue */
		    border-radius: 50%;
		    width: 20px;
		    height: 20px;
		    animation: spin 2s linear infinite;
		}

		@keyframes spin {
		    0% { transform: rotate(0deg); }
		    100% { transform: rotate(360deg); }
		}
 	</style>
  </head>
  <body>
 	<div class="container">
      <div class="header clearfix">
        <nav>
          <ul class="nav nav-pills float-right">
            <li class="nav-item">
              <a class="nav-link active" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Contact</a>
            </li>
          </ul>
        </nav>
        <h3 class="text-muted">Flight Delay Insurance<div id="loading"></div></h3>
      </div>

		<ul class="nav nav-tabs" id="myTab" role="tablist">
	  		<li class="nav-item">
	    		<a class="nav-link active" id="insurant-tab" data-toggle="tab" href="#insurant" role="tab" aria-controls="insurant" aria-expanded="true">Insurant</a>
	  		</li>
	  		<li class="nav-item">
	    		<a class="nav-link" id="insurer-tab" data-toggle="tab" href="#insurer" role="tab" aria-controls="insurer">Insurer</a>
	  		</li>
			<button type="button" class="btn btn-primary" style="margin-left:380px;" data-toggle="modal" data-target="#myModal">
			  	New Insurance
			</button>
		</ul>
		<div class="tab-content" id="myTabContent">
		  <div class="tab-pane fade show active" id="insurant" role="tabpanel" aria-labelledby="insurant-tab">
		  	<table class="table">
			  <thead>
			    <tr>
			      <th>Airline<br/>Code</th>
			      <th>Flight<br/>Number</th>
			      <th>Flight<br/>Date</th>
			      <th>Insurance<br/>Value</th>
			      <th>Insurance<br/>State</th>
				  <th>Flight<br/>State</th>
			      <th>Price</th>
			      <th>Action</th>
			    </tr>
			  </thead>
			  <tbody id="insurantTable"></tbody>
			</table>
		  </div>

		  <div class="tab-pane fade" id="insurer" role="tabpanel" aria-labelledby="insurer-tab">
		  	<table class="table">
			  <thead>
			    <tr>
			      <th>Airline<br/>Code</th>
			      <th>Flight<br/>Number</th>
			      <th>Flight<br/>Date</th>
			      <th>Insurance<br/>Value</th>
			      <th>Insurance<br/>State</th>
				  <th>Flight<br/>State</th>
			      <th>Price</th>
			      <th>Action</th>
			    </tr>
			  </thead>
			  <tbody id="insurerTable"></tbody>
			</table>
		  </div>
		</div>

<!--       <div class="jumbotron">
        <h1 class="display-3">Jumbotron heading</h1>
        <p class="lead">Cras justo odio, dapibus ac facilisis in, egestas eget quam. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus.</p>
        <p><a class="btn btn-lg btn-success" href="#" role="button">Sign up today</a></p>
      </div>

      <div class="row marketing">
        <div class="col-lg-6">
          <h4>Subheading</h4>
          <p>Donec id elit non mi porta gravida at eget metus. Maecenas faucibus mollis interdum.</p>

          <h4>Subheading</h4>
          <p>Morbi leo risus, porta ac consectetur ac, vestibulum at eros. Cras mattis consectetur purus sit amet fermentum.</p>

          <h4>Subheading</h4>
          <p>Maecenas sed diam eget risus varius blandit sit amet non magna.</p>
        </div>

        <div class="col-lg-6">
          <h4>Subheading</h4>
          <p>Donec id elit non mi porta gravida at eget metus. Maecenas faucibus mollis interdum.</p>

          <h4>Subheading</h4>
          <p>Morbi leo risus, porta ac consectetur ac, vestibulum at eros. Cras mattis consectetur purus sit amet fermentum.</p>

          <h4>Subheading</h4>
          <p>Maecenas sed diam eget risus varius blandit sit amet non magna.</p>
        </div>
      </div> -->

      <footer class="footer">
        <p>&copy; BlockInfinity 2017</p>
      </footer>
    </div> <!-- /container -->

	<!-- Modal -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="exampleModalLabel">New Insurance</h5>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body">
			<form>
			  <div class="form-group">
			    <label for="inputAirlineCode">Airline Code</label>
			    <input type="text" class="form-control" id="inputAirlineCode" value="LH" placeholder="LH">
			  </div>
			  <div class="form-group">
			    <label for="inputFlightNumber">Flight Number</label>
			    <input type="text" class="form-control" id="inputFlightNumber" value="303" placeholder="10">
			  </div>
			  <div class="form-group">
			    <label for="inputFlightDate">Flight Date</label>
			    <input type="text" class="form-control" id="inputFlightDate" value="2017-09-20" placeholder="2017-09-20">
			  </div>
			  <div class="form-group">
			    <label for="inputInsuranceValue">Insurance Value</label>
			    <input type="text" class="form-control" id="inputInsuranceValue" value="100000" placeholder="100">
			  </div>
			</form>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
	        <button type="button" class="btn btn-primary" id="createinsurance">Create Insurance</button>
	      </div>
	    </div>
	  </div>
	</div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script id="requested-template" type="text/x-jQuery-tmpl">
		<tr>
	      <th scope="row">${airlinecode}</th>
	      <td>${flightnumber}</td>
	      <td>${originflightdate}</td>
	      <td>${insuranceValue}</td>
	      <td>${state}</td>
	      <td>${status}</td>
	      <td>${price}</td>
	      <td>None</td>
	    </tr>
    </script>
    <script id="accepted-template" type="text/x-jQuery-tmpl">
		<tr>
	      <th scope="row">${airlinecode}</th>
	      <td>${flightnumber}</td>
	      <td>${originflightdate}</td>
	      <td>${insuranceValue}</td>
	      <td>${state}</td>
	      <td>${status}</td>
	      <td>${price}</td>
	      <td>
	      	<button type="button" class="btn btn-primary" data-type="confirm" data-id="${id}">Confirm</button>
	      </td>
	    </tr>
    </script>
    <script id="confirmed-template" type="text/x-jQuery-tmpl">
		<tr>
	      <th scope="row">${airlinecode}</th>
	      <td>${flightnumber}</td>
	      <td>${originflightdate}</td>
	      <td>${insuranceValue}</td>
	      <td>${state}</td>
	      <td>${status}</td>	      
	      <td>${price}</td>
	      <td>
	      	<button type="button" class="btn btn-primary" data-type="trigger" data-id="${id}">Trigger</button>
	      </td>
	    </tr>
    </script>
    <script id="insurer-requested-template" type="text/x-jQuery-tmpl">
		<tr>
	      <th scope="row">${airlinecode}</th>
	      <td>${flightnumber}</td>
	      <td>${originflightdate}</td>
	      <td>${insuranceValue}</td>
	      <td>${state}</td>
	      <td>${status}</td>	      
	      <td>
	      	<input type="text" class="form-control" placeholder="Price" value="100" id="price-${id}">
	      </td>
	      <td>
	      	<button type="button" class="btn btn-primary" data-type="accept" data-id="${id}">Accept</button>
	      </td>
	    </tr>
    </script>
    <script id="insurer-accepted-template" type="text/x-jQuery-tmpl">
		<tr>
	      <th scope="row">${airlinecode}</th>
	      <td>${flightnumber}</td>
	      <td>${originflightdate}</td>
	      <td>${insuranceValue}</td>
	      <td>${state}</td>
	      <td>${status}</td>	  
	      <td>${price}</td>
	      <td>
	      	<button type="button" class="btn btn-primary" data-type="close" data-id="${id}">Close</button>
	      </td>
	    </tr>
    </script>
    <script id="generic-template" type="text/x-jQuery-tmpl">
		<tr>
	      <th scope="row">${airlinecode}</th>
	      <td>${flightnumber}</td>
	      <td>${originflightdate}</td>
	      <td>${insuranceValue}</td>
	      <td>${state}</td>
	      <td>${status}</td>
	      <td>${price}</td>
	      <td>None</td>
	    </tr>
    </script>
    <script id="balance-template" type="text/x-jQuery-tmpl">
		<tr>
	      <th scope="row">Balance:</th>
	      <td colspan="7">${balance} (Previous Balance: ${previousBalance})</td>
	    </tr>
    </script>
    <script>
		(function($) {
			var previousBalanceFromInsurant = -1
			var previousBalanceFromInsurer = -1
			$('#createinsurance').on('click', function (e) {
				e.stopPropagation();

				if (!$('#inputAirlineCode').val() || !$('#inputFlightNumber').val() || 
					!$('#inputFlightDate').val() || !$('#inputInsuranceValue').val())
					return

				var data = {
					airlinecode: $('#inputAirlineCode').val(),
  					flightnumber: $('#inputFlightNumber').val(),
    				originflightdate: $('#inputFlightDate').val(),
    				insuranceValue: $('#inputInsuranceValue').val()
				};

				$.ajax({
				    type: 'POST',
				    url: '/api/request',
				    data: JSON.stringify(data),
				    success: function(data) { 
				    	$('#myModal').modal('hide')
						$("#insurant-tab").trigger("click");
				    },
				    contentType: "application/json"
				});
			})

		   	$('#myTab a').click(function (e) {
			  	e.preventDefault()
			  	$(this).tab('show')
			  	var self = this
			  	
			  	// request up-to-date from server
			  	$.get("api/requests", function(data) {
			  	  if ($(self).attr('id') === 'insurant-tab') {
			  	  	$.get("api/getBalanceFromInsurant", function(balance) {
				  	  	$('#insurantTable').empty()
				  	  	if (data.length === 0) {
				  	  		$('#insurantTable').html("No entries")
				  	  		return
				  	  	}
				  	  	for (var i=0;i<data.length;i++) {
				  	  		if (data[i].state === 'requested') {
								$("#requested-template").tmpl(data[i]).appendTo("#insurantTable")
				  	  		}
				  	  		else if (data[i].state === 'accepted') {
								$("#accepted-template").tmpl(data[i]).appendTo("#insurantTable")
				  	  		}
				  	  		else if (data[i].state === 'confirmed') {
								$("#confirmed-template").tmpl(data[i]).appendTo("#insurantTable")
				  	  		} 
				  	  		else {
								$("#generic-template").tmpl(data[i]).appendTo("#insurantTable")
				  	  		}
				  	  	}
				  	  	$("#balance-template").tmpl({balance:balance,previousBalance:previousBalanceFromInsurant}).appendTo("#insurantTable")
				  	  	previousBalanceFromInsurant = balance
				  	})
			  	  } else if ($(self).attr('id') === 'insurer-tab') {
			  	  	$.get("api/getBalanceFromInsurer", function(balance) {
				  	  	$('#insurerTable').empty()
				  	  	if (data.length === 0) {
				  	  		$('#insurerTable').html("No entries")
				  	  		return
				  	  	}
				  	  	for (var i=0;i<data.length;i++) {
				  	  		if (data[i].state === 'requested') {
								$("#insurer-requested-template").tmpl(data[i]).appendTo("#insurerTable")
				  	  		}
				  	  		else if (data[i].state === 'accepted') {
								$("#insurer-accepted-template").tmpl(data[i]).appendTo("#insurerTable")
				  	  		}
				  	  		else {
								$("#generic-template").tmpl(data[i]).appendTo("#insurerTable")
				  	  		}
				  	  	}
				  	    $("#balance-template").tmpl({balance:balance,previousBalance:previousBalanceFromInsurer}).appendTo("#insurerTable")
				  	    previousBalanceFromInsurer = balance
				  	})
			  	  }
				});
			})

			// simulate click
			$("#insurant-tab").trigger("click");

			$('#insurantTable').on('click', function (e) {
				e.stopPropagation();
				if ($(e.target).attr('data-type') === 'confirm') {
					$.post("/api/confirm", { id: $(e.target).attr('data-id') }, function( data ) {
						$("#insurant-tab").trigger("click");
					});
				}
				if ($(e.target).attr('data-type') === 'trigger') {
					$.post("/api/trigger", { id: $(e.target).attr('data-id') }, function( data ) {
						$("#insurant-tab").trigger("click");
					});
				}
			})

			$('#insurerTable').on('click', function (e) {
				e.stopPropagation();
				if ($(e.target).attr('data-type') === 'accept') {
					$.post("/api/accept", { id: $(e.target).attr('data-id'), price: $("#price-" + $(e.target).attr('data-id')).val() }, function( data ) {
						$("#insurer-tab").trigger("click");
					});
				}
				if ($(e.target).attr('data-type') === 'close') {
					$.post("/api/close", { id: $(e.target).attr('data-id') }, function( data ) {
						$("#insurer-tab").trigger("click");
					});
				}
			})

			$.ajaxSetup({
			    beforeSend:function(){
			        // show gif here, eg:
			        $("#loading").show();
			    },
			    complete:function(){
			        // hide gif here, eg:
			        $("#loading").hide();
			    }
			});

			$("#inputFlightDate").datepicker({ dateFormat: 'yy-mm-dd' });
		})(jQuery);
    </script>
  </body>
</html>